#!/usr/bin/env python3
# -*- coding:utf-8 -*--
import functools
import os
import requests
import random
from multiprocessing.pool import ThreadPool
from tqdm import tqdm

header = {
    'origin': 'https://www.pianku.tv',
    'referer': 'https://www.pianku.tv/py/lJWMpVmYqRWb_1.html?158064',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36 Edg/81.0.416.72'
}
proxies = ['HTTP://110.243.30.23:9999', 'HTTP://222.189.191.206:9999', 'HTTP://118.212.104.138:9999',
           'HTTP://182.149.83.97:9999', 'HTTP://106.42.163.100:9999', 'HTTP://120.83.107.69:9999',
           'HTTP://60.13.42.135:9999', 'HTTP://60.205.188.24:3128', 'HTTP://113.195.232.23:9999',
           'HTTP://59.62.36.74:9000', 'HTTP://218.2.226.42:80']
proxy = {'HTTP': random.choice(proxies)}
proxy = None
print(proxy)
path = '/Users/chubin.zheng/Desktop/BJTU课程/WEB搜索与推荐系统导论/'

if os.path.exists(path + "视频/"):
    pass
else:
    os.makedirs(path + "视频/")

failure_list = []  # 保存下载失败的片段

def download(num, date='', file='', flag=0):
    url = file.format(num=num)
    with open(path + "视频/" + date + "/" + str(num) + ".ts", 'wb') as f:
        try:
            # r = requests.get(url, proxies=proxy, headers=header, timeout=5, stream=True)
            r = requests.get(url, proxies=proxy, headers=header, timeout=5)
            r.raise_for_status()
            r.encoding = 'utf-8'
            print('正在下载第 {} 个片段。'.format(num))
            f.write(r.content)
            if flag == 1:
                failure_list.remove(num)
        except:
            print('请求失败！')
            if num not in failure_list:
                failure_list.append(num)

def get_video(date):
    cur_path = path + "视频/" + date
    files = os.listdir(cur_path)
    files = filter(lambda x: x.endswith(".ts"), files)
    files = list(map(lambda x: (x, int(x.split(".")[0])), files))
    files = sorted(files, key=lambda x: x[1])
    print(files)
    for file, _ in tqdm(files, desc="正在转换视频格式："):
        file = path + "视频/" + date + "/" + file
        if os.path.exists(file):
            with open(file, 'rb') as f1:
                with open(cur_path + ".ts", 'ab') as f2:
                    f2.write(f1.read())
        else:
            print("失败")


if __name__ == '__main__':
    # 开启线程池
    VEDIOS = {
        # "20220830-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/08/30/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220830185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220830000506766.mp4/media_w778956473_{num}.ts',
        # "20220830-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/08/30/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220830205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220830000506766.mp4/media_w877334592_{num}.ts",
        # "20220906-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/06/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220906185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220906000009620.mp4/media_w19774471_{num}.ts",
        # "20220906-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/06/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220906205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220906000009636.mp4/media_w576251914_{num}.ts",
        # "20220913-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/13/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220913185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220913000018350.mp4/media_w888758629_{num}.ts",
        # "20220913-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/13/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220913205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220913000018350.mp4/media_w2012127968_{num}.ts",
        # "20220920-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/20/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220920185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220920000027191.mp4/media_w1739750011_{num}.ts",
        # "20220920-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/20/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220920205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E5%AD%A6%E7%94%9F_20220920000027191.mp4/media_w378634237_{num}.ts",
        # "20220927-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/27/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220927185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220927000001790.mp4/media_w365966221_{num}.ts",
        # "20220927-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/27/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20220927205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20220927000001790.mp4/media_w641187672_{num}.ts",
        # "20221004-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/04/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221004185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221004000009003.mp4/media_w856479661_{num}.ts",
        # "20221004-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/04/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221004205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221004000009003.mp4/media_w2009308904_{num}.ts",
        # "20221025-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/25/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221025185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221025000030573.mp4/media_w2035055440_{num}.ts",
        # "20221025-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/25/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221025205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221025000030573.mp4/media_w1142666878_{num}.ts",
        "20221101-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/11/01/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221101185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221101000037783.mp4/media_w936144513_{num}.ts",
        # "20221101-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/11/01/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221101205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221101000037783.mp4/media_w2096582130_{num}.ts",
        # "20221108-1": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/11/08/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221108185500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221108000044703.mp4/media_w2029992021_{num}.ts",
        # "20221108-2": "http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/11/08/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2C402005B01/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/%E9%82%AC%E4%BF%8A_20221108205500000/WEB%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA_%E9%82%AC%E4%BF%8A_%E8%AF%BE%E4%BB%B6_20221108000044703.mp4/media_w1564943638_{num}.ts",
    }
    for k, v in VEDIOS.items():
        print(k)
        pool = ThreadPool(8)
        if not os.path.exists(path + "视频/" + k):
            os.makedirs(path + "视频/" + k)
        results = pool.map(functools.partial(download, date=k, file=v), range(1, 701))
        pool.close()
        pool.join()

        get_video(k)
