#!/usr/bin/env python3
# -*- coding:utf-8 -*--
import functools
import os
import requests
import random
from multiprocessing.pool import ThreadPool
from tqdm import tqdm

header = {
    'origin': 'https://www.pianku.tv',
    'referer': 'https://www.pianku.tv/py/lJWMpVmYqRWb_1.html?158064',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36 Edg/81.0.416.72'
}
proxies = ['HTTP://110.243.30.23:9999', 'HTTP://222.189.191.206:9999', 'HTTP://118.212.104.138:9999',
           'HTTP://182.149.83.97:9999', 'HTTP://106.42.163.100:9999', 'HTTP://120.83.107.69:9999',
           'HTTP://60.13.42.135:9999', 'HTTP://60.205.188.24:3128', 'HTTP://113.195.232.23:9999',
           'HTTP://59.62.36.74:9000', 'HTTP://218.2.226.42:80']
proxy = {'HTTP': random.choice(proxies)}
proxy = None
print(proxy)
path = '/Users/chubin.zheng/Desktop/BJTU课程/算法设计与分析/'

if os.path.exists(path + "视频/"):
    pass
else:
    os.makedirs(path + "视频/")

failure_list = []  # 保存下载失败的片段

def download(num, date='', file='', flag=0):
    url = file.format(num=num)
    with open(path + "视频/" + date + "/" + str(num) + ".ts", 'wb') as f:
        try:
            # r = requests.get(url, proxies=proxy, headers=header, timeout=5, stream=True)
            r = requests.get(url, proxies=proxy, headers=header, timeout=5)
            r.raise_for_status()
            r.encoding = 'utf-8'
            print('正在下载第 {} 个片段。'.format(num))
            f.write(r.content)
            if flag == 1:
                failure_list.remove(num)
        except:
            print('请求失败！')
            if num not in failure_list:
                failure_list.append(num)

def get_video(date):
    cur_path = path + "视频/" + date
    files = os.listdir(cur_path)
    files = filter(lambda x: x.endswith(".ts"), files)
    files = list(map(lambda x: (x, int(x.split(".")[0])), files))
    files = sorted(files, key=lambda x: x[1])
    print(files)
    for file, _ in tqdm(files, desc="正在转换视频格式："):
        file = path + "视频/" + date + "/" + file
        if os.path.exists(file):
            with open(file, 'rb') as f1:
                with open(cur_path + ".ts", 'ab') as f2:
                    f2.write(f1.read())
        else:
            print("失败")


if __name__ == '__main__':
    # 开启线程池
    VEDIOS = {
        # "20220903-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/03/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220903185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220903000005877.mp4/media_w1029334155_{num}.ts',
        # "20220903-2": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/03/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220903205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220903000005877.mp4/media_w939246983_{num}.ts',
        # "20220909-1": 'http://123.121.147.11:1935/vod2/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/09/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220909185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220909000011789.mp4/media_w1652164772_{num}.ts',
        # "20220909-2": 'http://123.121.147.11:1935/vod2/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/09/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220909205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220909000011789.mp4/media_w2136853038_{num}.ts',
        # "20220917-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/17/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220917185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220917000023237.mp4/media_w288160213_{num}.ts',
        # "20220917-2": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/17/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220917205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220917000023237.mp4/media_w682518560_{num}.ts',
        # "20220924-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/24/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220924185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220924102958594.mp4/media_w1127559457_{num}.ts',
        # "20220924-2": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/24/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220924205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220924102958594.mp4/media_w848867984_{num}.ts',
        # "20220930-1": 'http://123.121.147.11:1935/vod3/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/30/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220930185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220930000009160.mp4/media_w1824427292_{num}.ts',
        # "20220930-2": 'http://123.121.147.11:1935/vod3/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/09/30/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20220930205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20220930000009160.mp4/media_w1767581341_{num}.ts',
        # "20221008-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/08/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20221008185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20221008000012767.mp4/media_w942659668_{num}.ts',
        # "20221008-2": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/08/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20221008205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20221008000012767.mp4/media_w407174124_{num}.ts',
        # "20221015-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/15/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20221015185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20221015000020737.mp4/media_w639678738_{num}.ts',
        # "20221015-2": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/15/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20221015205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20221015000020737.mp4/media_w1488275565_{num}.ts',

        "20221029-1": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/29/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20221029185500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20221029000034641.mp4/media_w1796771130_{num}.ts',
        "20221029-2": 'http://123.121.147.13:1935/vod4/_definst_/%E8%87%AA%E5%8A%A8%E5%BD%95%E5%88%B6_%E5%85%B3%E8%81%94%E8%AF%BE%E8%A1%A8/2022-20232022-2023%E7%AC%AC%E4%B8%80%E5%AD%A6%E6%9C%9F/2022/10/29/%E4%B8%BB%E6%A0%A1%E5%8C%BA/2019%E5%B9%B4%E7%BA%A7/2019%E7%BA%A72022-2023-1-2M502022B11/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90/%E8%B5%B5%E5%AE%8F%E6%99%BA_20221029205500000/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%88%86%E6%9E%90_%E8%B5%B5%E5%AE%8F%E6%99%BA_%E8%AF%BE%E4%BB%B6_20221029000034641.mp4/media_w1199331591_{num}.ts',
        # "20221105-1": '',
        # "20221105-2": '',
        # "20221112-1": '',
        # "20221112-2": '',
    }
    for k, v in VEDIOS.items():
        print(k)
        pool = ThreadPool(8)
        if not os.path.exists(path + "视频/" + k):
            os.makedirs(path + "视频/" + k)
        results = pool.map(functools.partial(download, date=k, file=v), range(1, 701))
        pool.close()
        pool.join()

        get_video(k)
